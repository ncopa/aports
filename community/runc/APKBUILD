# Maintainer: Bernhard J. M. Gruen <bernhard.gruen@googlemail.com>
pkgname=runc
pkgver="1.0.0_rc6"
pkgrel=0
pkgdesc="CLI tool for managing OCI compliant containers"
url="https://runc.io/"
arch="all"
license="Apache-2.0"
makedepends="go libtool libseccomp-dev"

_commit="ccb5efd37fb7c86364786e9137e22948751de7ed"
_go_md2man_ver="1.0.8"

source="runc-$pkgver.tar.gz::https://github.com/opencontainers/runc/archive/$_commit.tar.gz
	go-md2man-$_go_md2man_ver.tar.gz::https://github.com/cpuguy83/go-md2man/archive/v$_go_md2man_ver.tar.gz
	"
	
subpackages="
	$pkgname-doc
	"

builddir="$srcdir"/runc-$_commit
go_md2man_builddir="$srcdir"/go-md2man

prepare() {
	cd "$builddir"
	mv -f vendor src
	mkdir -p src/github.com/opencontainers
	ln -s "$builddir" src/github.com/opencontainers/runc
}

build() {
	# Required for building man-pages
	ln -s  "$go_md2man_builddir"-"$_go_md2man_ver" "$go_md2man_builddir"
	export GOPATH="$go_md2man_builddir"
	export GOBIN="$GOPATH/bin"
	export PATH="$GOBIN:$PATH"
	cd "$go_md2man_builddir"
	go get

	cd "$builddir"
	GOPATH="$PWD" BUILDTAGS="seccomp" make COMMIT="_commit" runc man
}

check() {
	cd "$builddir"
	./runc --version
}

package() {
	cd "$builddir"

	install -Dm755 "$builddir"/runc "$pkgdir"/usr/bin/runc
	install -d "$pkgdir"/usr/share/man/man8/
	install -Dm644 "$builddir"/man/man8/* "$pkgdir"/usr/share/man/man8/
}

sha512sums="2f7ed5e835f000d9810a116a27300336f424ac2c370dd1c7d158e26a4997d1e8398612387be27cc22cc25fdd52cc4cff7963ef88ce9c41d337321b75d9be2334  runc-1.0.0_rc6.tar.gz
4c52e01c9b07582b5d55d1e94935378a676bd284a3e8230a8a191d4678b1b6ae92b704a249117c542832170069a70c649e58a1752fb2973709259b5bc108db91  go-md2man-1.0.8.tar.gz"
